<p class="t cent botli">校園映像資料管理</p>
<table style="width:100%">
  <thead>
    <tr class="yel">
      <th style="width:68%">校園映像圖片</th>
      <th style="width:7%">顯示</th>
      <th style="width:7%">刪除</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<nav id="pagination-bar">
  <ul id="pagination-item"></ul>
</nav>
<table style="margin-top:10px; width:70%;">
  <tbody>
    <tr>
      <td style="width:200px">
        <input type="button" id="btnadd" />
      </td>
      <td class="cent">
        <input type="submit" value="修改確定" />
        <input type="reset" value="重置" />
      </td>
    </tr>
  </tbody>
</table>
<script type="text/javascript">
  jQuery(document).ready(
    function () {
      //根據域名決定請求路徑
      const API_PATH = location.hostname === 'localhost' ? '/ClassB/WebB01' : '..';
      let pagecount, rowcount, pagecurrent = 1, rows = [];
      //載入並渲染分頁頁碼
      jQuery.getJSON(
        `${API_PATH}/Fetch.ashx`,
        {
          item: 'CampusImage'
        },
        returns => {
          rows = returns;
          rowcount = rows.length;
          pagecount = Math.ceil(rowcount / 3);
          jQuery("#pagination-item").empty();
          let paginationlink =
            `<li>
              <a href="" id="prev" style="text-decoration:none">
                <
              </a>
            </li>`;
          for (let i = 1; i <= pagecount; i++) {
            paginationlink +=
              `<li`;
            if (i === pagecurrent) {
              paginationlink +=
                ` style="font-size:20px"`;
            }
            paginationlink +=
              `>${i}
              </li>`;
          }
          paginationlink +=
            `<li>
              <a href="" id="next" style="text-decoration:none">
                >
              </a>
            </li>`;
          jQuery("#pagination-item").html(paginationlink);
          fetchrow(0, 3);
        }

      );
      jQuery("#pagination-item").on(
        'click',
        "#prev",
        event => {
          //上一頁
          event.preventDefault();
          pagecurrent--;
          if (pagecurrent < 1) {
            pagecurrent = 1;
          } else {
            jQuery("#pagination-item").children("li").each(
              function () {
                if (jQuery(this).text() == pagecurrent) {
                  jQuery(this).css('font-size', '20px');
                } else {
                  jQuery(this).css('font-size', '12px');
                }
              }
            );
            fetchrow((pagecurrent - 1) * 3, 3);
          }
        }
      );
      jQuery("#pagination-item").on(
        'click',
        "#next",
        event => {
          //下一頁
          event.preventDefault();
          pagecurrent++;
          if (pagecurrent > pagecount) {
            pagecurrent = pagecount;
          } else {
            fetchrow((pagecurrent - 1) * 3, 3);
            jQuery("#pagination-item").children("li").each(
              function () {
                if (jQuery(this).text() == pagecurrent) {
                  jQuery(this).css('font-size', '20px');
                } else {
                  jQuery(this).css('font-size', '12px');
                }
              }
            );
          }
        }
      );
      jQuery("#btnadd").val('新增校園映像圖片').click(
        () => {
          //渲染並顯示modal(新增)
          jQuery("#cvr").html(
            `<p class="t cent">新增校園映像圖片</p>
            <hr/>
            校園映像圖片：<input id="Picture" name="Picture" type="file" accept="image/*"/><br/>
            <button id="Insert" type="button">新增</button>
            <button id="Clear" type="button">重置</button>`
          );
          jQuery("#cover").fadeIn();
        }
      );
      jQuery("form").on(
        'click',
        "input[name='update']",
        function () {
          //渲染並顯示modal(修改)
          jQuery("#cvr").html(
            `<p class="t cent">變更校園映像圖片</p><hr/>
            <input id="rowid" type="hidden" value="${jQuery(this).parent("tr").attr('id')}"/>
            校園映像圖片：<input id="Picture" name="Picture" type="file" accept="image/*"/><br/>
            <button id="Update" type="button">變更</button>
            <button id="Clear" type="button">重置</button>`
          );
          jQuery("#cover").fadeIn();
        }
      );
      let form = new FormData();
      jQuery("form").on(
        'click',
        "#Insert",
        () => {
          //上傳新的校園映像，並在表格增加一列以顯示
          let file = jQuery("#Picture").get(0).files[0];
          form.append('Picture', file);
          fetch(
            `${API_PATH}/Upload.ashx`,
            {
              method: 'post',
              body: form
            }
          ).then(
            () => {
              jQuery.post(
                `${API_PATH}/Add.ashx`,
                {
                  item: 'CampusImage',
                  Filename: file.name,
                  Display: 'no'
                },
                returns => {
                  if (returns !== 'fail') { location.reload(); }
                }
              );
            }
          )
        }
      );
      jQuery("form").on(
        'click',
        "#Update",
        () => {
          //重新上傳校園映像，並在表格內顯示
          let file = jQuery("#Picture").get(0).files[0];
          let id = jQuery("#rowid").val();
          form.append('Picture', file);
          fetch(
            `${API_PATH}/Upload.ashx`,
            {
              method: 'post',
              body: form
            }
          ).then(
            () => {
              rows[rows.findIndex(r => r.Id === id)].FileName = file.name;
              jQuery(`tr#${id}`).find("img").attr('src', `${API_PATH}/Content/Images/${file.name}`);
              jQuery("#cover").fadeOut();
            }
          );
        }
      );
      jQuery("form").on(
        'click',
        "#Clear",
        () => {
          //清除校園映像
          jQuery("#Picture").empty();
        }
      );
      jQuery("form").submit(
        event => {
          event.preventDefault();
          jQuery("tbody:nth-child(2) tr").each(
            function () {
              if (jQuery(this).find("input[name='delete']").prop('checked')) {
                //批次刪除
                jQuery.get(
                  `${API_PATH}/Remove.ashx`,
                  {
                    item: 'CampusImage',
                    Id: jQuery(this).attr('id')
                  },
                  returns => {
                    if (returns === 'success') { jQuery(this).remove(); }
                  }
                );
              } else {
                //批次修改
                jQuery.post(
                  `${API_PATH}/Modify.ashx`,
                  {
                    item: 'CampusImage',
                    Id: jQuery(this).attr('id'),
                    FileName: jQuery(this).find("img").attr('src').replace(`${API_PATH}/Content/Images/`, ''),
                    Display: jQuery(this).find("input[name='display']").prop('checked') ? 'yes' : 'no'
                  }
                );
              }
            }
          );
          location.reload();
        }
      );
      //渲染表格
      function fetchrow (skipnum, fetchnum) {
        jQuery("tbody:nth-child(2)").html("");
        for (let key = skipnum; key < fetchnum + skipnum; key++) {
          if (key === rowcount) break
          let row_html =
            `<tr id="${rows[key].Id}" class="trce">
                <td><img src="${API_PATH}/Content/Images/${rows[key].FileName}" height="68" width="100"/></td>
                <td><input type="checkbox" name="display"`;
          if (rows[key].Display === 'yes') { row_html += ' checked'; }
          row_html += `/></td>
                <td><input type="checkbox" name="delete"/>
                <td><input name="update" type="button" value="變更圖片" /></td>
              '</tr>`;
          jQuery("tbody:nth-child(2)").append(row_html);
        }
      }
    }
  );
</script>
