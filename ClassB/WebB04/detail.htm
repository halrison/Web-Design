<h1></h1>
<table style="width:100%;">
	<tr class="pp">
		<td rowspan="5">
			<img src="" alt="" id="icon"/>
		</td>
		<td>
			分類:
			<span id="category"></span>
		</td>
	</tr>
	<tr class="pp">
		<td>
			編號:
			<span id="number"></span>
		</td>
	</tr>
	<tr class="pp">
		<td>
			價格:
			<span id="price"></span>
		</td>
	</tr>
	<tr class="pp">
		<td>
			詳細說明:
			<span id="description"></span>
		</td>
	</tr>
	<tr class="pp">
		<td>
			庫存量:
			<span id="quantity"></span>
		</td>
	</tr>
	<tr class="tt">
		<td colspan="2" class="ct">
			購買數量
			<input id="amount" type="number" />
			<img src="Content/Images/0402.jpg" alt="我要購買" id="i_wanna_buy"/>
		</td>
	</tr>
</table>
<button>返回</button>
<style>
	#icon{
		width:100%;
	}
</style>
<script>
  //根據網址決定請求路徑
  const API_PATH = location.hostname === 'localhost' ? '/ClassB/WebB04' : '..'; 
  let bigCategory, mediumCategory;
  //載入商品資訊
  jQuery.getJSON(
    `${API_PATH}/Commodity.ashx`,
    {
      action: 'fetchone',
      number: new URLSearchParams(location.search).get('number')
    }
  ).done(
    async response => {
      let selectedCommodity = response[0];
      await jQuery.getJSON(
        `${API_PATH}/Big.ashx`,
        {
          action: 'fetch'
        },
        response => {
          bigCategory = response.find(category => category.id === selectedCommodity.big).name;
        }
      );
      await jQuery.getJSON(
        `${API_PATH}/Medium.ashx`,
        {
          action: 'fetch',
          big: selectedCommodity.big
        },
        response => {
          mediumCategory = response.find(category => category.id === selectedCommodity.medium).name;
        }
      );
	    jQuery("#icon").attr('src', `${API_PATH}/Content/Images/${selectedCommodity.picture}`);
			jQuery("h1").text(selectedCommodity.name);
			jQuery("#number").text(selectedCommodity.number);
			jQuery("#category").text(`${bigCategory}>${mediumCategory}`);
			jQuery("#price").text(selectedCommodity.price);
			jQuery("#description").text(selectedCommodity.description);
			jQuery("#quantity").text(selectedCommodity.quantity);
		}
	);
	jQuery("style").appendTo("head");
	//回上一頁
	jQuery("button").click(
		() => {
			history.back();
		}
	);
	jQuery("#i_wanna_buy").click(
		() => {
			//未登入就導向登入頁
			if (sessionStorage.getItem('account') === null || sessionStorage.getItem('account') === undefined) {
				location.assign('?do=login&user=member');
			} else {
				let orders = JSON.parse(sessionStorage.getItem('orders')) || [], searchIndex = orders.findIndex(order => order.number === jQuery("#number").text());
				if (searchIndex > -1) {
					orders[searchIndex].amount = jQuery("#amount").val();
				} else {
					//加入購物車
					orders.push(
						{
							number: jQuery("#number").text(),
							amount: jQuery("#amount").val()
						}
					);
				}
				sessionStorage.setItem('orders', JSON.stringify(orders));
				//導向購物車頁
				location.assign('?do=buycart');
			}
		}
	);
</script>