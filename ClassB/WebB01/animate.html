<p class="t cent botli">動畫圖片管理</p>
<table style="width:100%">
  <thead>
    <tr class="yel">
      <th style="width:68%">動畫圖片</th>
      <th style="width:7%">顯示</th>
      <th style="width:7%">刪除</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<table style="margin-top:10px; width:70%;">
  <tbody>
    <tr>
      <td style="width:200px">
        <input type="button" id="btnadd" />
      </td>
      <td class="cent">
        <input type="submit" value="修改確定" />
        <input type="reset" value="重置" />
      </td>
    </tr>
  </tbody>
</table>
<script type="text/javascript">
  jQuery(document).ready(
    function () {
      //根據域名決定請求路徑
      const API_PATH = location.hostname === 'localhost' ? '/ClassB/WebB01' : '..';
      //載入並渲染動畫圖片
      let rows = [];
      fetchrow();
      var form = new FormData();
      jQuery("#btnadd").val('新增動畫圖片').click(
        () => {
          //渲染並顯示modal
          jQuery("#cvr").html(
            `<p class="t cent botli">新增動畫圖片</p>
                        動畫圖片：<input id="Picture" name="Picture" type="file" accept="image/*"/><br/>
                        <button id="Insert" type="button">新增</button>
                        <button id="Clear" type="button">重置</button>`
          );
          jQuery("#cover").fadeIn();
        }
      );
      jQuery("form").on(
        'click',
        "#Insert",
        () => {
          //上傳動態圖片，並於表格內增加一列以顯示
          let file = jQuery("#Picture").get(0).files[0];
          form.append('Picture', file);
          fetch(
            `${API_PATH}/Upload.ashx`,
            {
              method: 'post',
              body: form
            }
          ).then(
            () => {
              jQuery.post(
                `${API_PATH}/Add.ashx`,
                {
                  item: 'AnimatePicture',
                  FileName: file.name,
                  Display: 'no'
                },
                returns => {
                  if (returns !== 'fail') { jQuery("#cover").fadeOut(); }
                }
              );
            }
          ).finally(() => { fetchrow(); });
        }
      );
      jQuery("form").on(
        'click',
        "input[name='Update']",
        function () {
          //渲染並顯示modal
          jQuery("#cvr").html(
            `<p class="t cent">變更動畫圖片</p>
            <hr/>
            動畫圖片：<input id="File" type="file" accept="image/*"/><br/>
            <input id="rowid" type="hidden" value="${jQuery(this).parents("tr").attr('id')}"/>
            <button id="Modify" type="button">變更</button>
            <button id="Clear" type="button">重置</button>`
          );
          jQuery("#cover").fadeIn();
        }
      );
      jQuery("form").on(
        'click',
        "#Modify",
        () => {
          //重新上傳圖片，並將新圖片顯示於表格中
          let file = jQuery("#File").get(0).files[0];
          let id = jQuery("#rowid").val();
          form.append('Picture', file);
          fetch(
            `${API_PATH}/Upload.ashx`,
            {
              method: 'post',
              body: form
            }
          ).then(
            () => {
              rows[rows.findIndex(r => r.Id === parseInt(id))].FileName = file.name;
              jQuery(`tr#${id}`).find("img").attr('src', `${API_PATH}/Content/Images/${file.name}`);
              jQuery("#cover").fadeOut();
            }
          );
        }
      );
      jQuery("form").submit(
        function (event) {
          event.preventDefault();
          jQuery("tbody:nth-child(2) tr").each(
            function () {
              if (jQuery(this).find("input[name='delete']").prop('checked')) {
                //批次刪除
                jQuery.get(
                  `${API_PATH}/Remove.ashx`,
                  {
                    item: 'AnimatePicture',
                    Id: jQuery(this).attr('id')
                  },
                  responses => {
                    if (responses === 'success') {
                      jQuery(this).remove();
                    }
                  }
                );
              } else {
                //批次修改
                jQuery.post(
                  `${API_PATH}/Modify.ashx`,
                  {
                    item: 'AnimatePicture',
                    Id: jQuery(this).attr('id'),
                    FileName: jQuery(this).find("img").attr('src').replace(`${API_PATH}/Content/Images/`, ""),
                    Display: jQuery(this).find("input[name='display']").prop('checked') ? 'yes' : 'no'
                  }
                );
              }
            }
          );
          fetchrow();
        }
      );
      function fetchrow () {
        jQuery.getJSON(
          `${API_PATH}/Fetch.ashx`,
          {
            item: 'AnimatePicture'
          },
          returns => {
            rows = returns; 
      jQuery("tbody:nth-child(2)").html("");
            rows.forEach(
              value => {
                let rows =
                  `<tr id="${parseInt(value.Id)}" class="trce">
                    <td>
                        <img src="${API_PATH}/Content/Images/${value.FileName}" height="120" width="80"/>
                    </td>
                    <td>
                        <input name="display" type="checkbox"`;
                if (value.Display == 'yes') {
                  rows += ` checked`;
                }
                rows += `/>
                    </td>
                    <td>
                        <input name="delete" type="checkbox" />
                    </td>
                    <td>
                        <input name="Update" type="button" value="更換動畫" />
                    </td>
                </tr>`;
                jQuery("tbody:nth-child(2)").append(rows);
              }
            );
          }
        );
      }
    }
  );
</script>
