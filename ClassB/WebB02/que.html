<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
    p {
      font-weight: bold;
    }

    th {
      background-color: white;
    }

    td {
      line-height: 20px;
    }

    ul {
      list-style-type: none;
    }

    #result a {
      text-decoration: none;
      border: 1px solid black;
    }

    #vote #Submit {
      text-decoration: none;
      border: 1px solid black;
    }
  </style>
</head>
<body>
  <nav>目前位置：首頁>問卷調查<span></span></nav>
  <div id="summary">
    <table style="width:100%;">
      <thead>
        <tr>
          <th>編號</th>
          <th>問卷題目</th>
          <th>投票總數</th>
          <th>結果</th>
          <th>狀態</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="result"></div>
  <div id="vote"></div>
  <script type="text/javascript">
    const API_PATH = location.hostname === 'localhost' ? '/ClassB/WebB02' : '';
    jQuery(document).ready(
      () => {
        jQuery("head").append(jQuery("style"));
        jQuery("#result,#vote").hide();
        jQuery.getJSON(
          `${API_PATH}/Fetch.ashx`,
          {
            item: 'QuestionnaireTopic'
          },
          response => {
            response.forEach(
              value => {
                let row =
                  `<tr id="${value.id}">
                        <td>${value.id}.</td>
                        <td>${value.topic}</td>
                        <td>${value.static}</td>
                        <td>
                          <a class="view-result">結果</a>
                        </td>
                        <td>`;
                if (sessionStorage.getItem('user') === null) {
                  row +=
                    `請先登入`;
                } else {
                  row +=
                    `<a class="votes">參與投票</a>`;
                }
                row +=
                  `</td>
                      </tr>`;
                jQuery("tbody").append(row);
              }
            );
          }
        );
        jQuery("#result").on(
          'click',
          "a",
          () => {
            jQuery("#result").hide();
            jQuery("#summary").show();
            jQuery("nav span").empty();
          }
        );
        jQuery("#vote").on(
          'click',
          ":submit",
          () => {
            jQuery.ajax(
              {
                url: `${API_PATH}/Modify.ashx`,
                method: 'post',
                data: {
                  item: 'QuestionnaireOption',
                  topic: jQuery("ul").data('id'),
                  option: jQuery(":checked").val()
                },
                async: false,
                success: response => {
                  if (response === 'Success') {
                    jQuery.ajax(
                      {
                        url: `${API_PATH}/Modify.ashx`,
                        method: 'post',
                        data: {
                          item: 'QuestionnaireTopic',
                          id: jQuery("ul").data('id'),
                        },
                        async: false,
                        success: response => {
                          if (response === 'Success') {
                            jQuery("#vote").hide();
                            jQuery("#summary").show();
                            jQuery("nav span").empty();
                          }
                        }
                      }
                    );
                  }
                }
              }
            );
          }
        );
      }
    );
    jQuery(document).on(
      'click',
      ".view-result",
      function(event) {
        event.preventDefault();
        let id = jQuery(this).parents("tr").attr('id'),
          total = jQuery(this).parent("td").prev().text(),
          topic = jQuery(this).parent("td").prev().prev().text()
        jQuery.ajax(
          {
            url: `${API_PATH}/Fetch.ashx`,
            method: 'get',
            data: {
              item: 'QuestionnaireOption',
              topic: id
            },
            beforeSend: () => {
              jQuery("nav span").text(`>${topic}`);
              jQuery("#result").empty();
            },
            dataType: 'json',
            success: response => {
              var result =
                `<p>${topic}</p>
                  <table>`;
              response.forEach(
                (value, index) => {
                  result +=
                    `<tr>
                      <td style='width:50%;'>${index + 1}.${value.option}</td>
                      <td>
                        <span style='width:${total === '0' ? 0 : value.count / parseInt(total) * 100}%;	background-color:lightgray; height: 20px; display: inline-block;'></span>${value.count}票(${total === '0' ? 0 : value.count / parseInt(total) * 100}%)
                      </td>
                    </tr>`;
                }
              );
              result +=
                `</table>
                  <a>返回</a>`;
              jQuery("#result").html(result).show();
              jQuery("#summary").hide();
            }
          }
        );
      }
    )
    jQuery(document).on(
      'click',
      ".votes",
      function (event) {
        event.preventDefault();
        let id = jQuery(this).parents("tr").attr('id'), 
          topic = jQuery(this).parents("tr").find("td:nth-child(2)").text()
        jQuery.ajax(
          {
            url: `${API_PATH}/Fetch.ashx`,
            method: 'get',
            data: {
              item: 'QuestionnaireOption',
              topic: id
            },
            beforeSend: () => {
              jQuery("nav span").text(`>${topic}`);
              jQuery("#vote").empty();
            },
            dataType: 'json',
            success: response => {
              let vote =
                `<p>${topic}</p>
                  <ul data-id='${id}'>`;
              response.forEach(
                value => {
                  vote +=
                    `<li>
                      <input type='radio' name='option' value='${value.option}'/>
                      ${value.option}
                    </li>`;
                }
              );
              vote +=
                `</ul>
                  <input type="submit" value="我要投票" />`;
              jQuery("#vote").html(vote).show();
              jQuery("#summary").hide();
            }
          }
        );
      }
    )
  </script>
</body>
</html>