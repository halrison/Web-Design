<p class="botli t cent">選單管理</p>
<table style="width:100%">
  <thead>
    <tr class="yel">
      <th style="width:40%">主選單名稱</th>
      <th style="width:40%">選單連結網址</th>
      <th style="width:10%">次選單數</th>
      <th>顯示</th>
      <th>刪除</th>
      <th style="width:15%"></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<table style="margin-top:10px; width:70%;">
  <tbody>
    <tr>
      <td style="width:200px">
        <input type="button" id="btnadd" />
      </td>
      <td class="cent">
        <input type="submit" value="修改確定" />
      </td>
    </tr>
  </tbody>
</table>
<script type="text/javascript">
  jQuery(document).ready(
    function () {
      let rows = [];
      //根據域名決定請求路徑
      const API_PATH = location.hostname === 'localhost' ? '/ClassB/WebB01' : '..';
      jQuery("tbody:nth-child(2)").html("");
fetchrow();
      jQuery("#btnadd").val('新增主選單').click(
        () => {
          //渲染並顯示modal(主選單)
          jQuery("#cvr").html(
            `<p class="botli t cent">新增主選單</p>
            主選單名稱：<input id="MainName" type="text" />
            主選單連結網址：<input id="MainUrl" type="text" />
            <button id="Insert">新增</button>
            <button id="Clear">重置</button>`
          );
          jQuery("#cover").fadeIn();
        }
      );
      jQuery("form").on(
        'click',
        "#Insert",
        () => {
          //新增主選單，並在表格增加一列
          jQuery.post(
            `${API_PATH}/Add.ashx`,
            {
              item: 'MainMenu',
              Name: jQuery("#MainName").val(),
              Url: jQuery("#MainUrl").val(),
              Display: 'no',
              Count: 0
            },
            returns => {
              if(returns !== 'fail'){
                fetchrow();
                jQuery("#cover").fadeOut();
              }
            }
          );
        }
      );
      jQuery("form").on(
        'click',
        "input[name='Edit']",
        function () {
          //載入並渲染子選單
          let id = jQuery(this).parents("tr").attr('id').replace('main-', '')
          jQuery.getJSON(
            `${API_PATH}/Fetch.ashx`,
            {
              item: 'SubMenu',
              Father: id
            },
            returns => {
              let row =
                `<p class="botli t cent">編輯次選單</p>
                <table>
                  <thead>
                    <tr>
                      <th>次選單名稱</th>
                      <th>次選單連結網址</th>
                      <th>刪除</th>
                    </tr>
                  </thead>
                  <tbody>`;
              jQuery.each(
                returns,
                (key, value) => {
                  row +=
                    `<tr id="sub-${value.Id}" class="trce">
                      <td>
                        <input name="sub-name" type="text" value="${value.Name}" />
                      </td>
                      <td>
                        <input name="sub-url" type="text" value="${value.Url}"/>
                      </td>
                      <td>
                        <input name="sub-delete" type="checkbox" />
                      </td>
                    </tr>`;
                }
              );
              row +=
                `</tbody >
                </table>
                <input id="main-id" type="hidden" value="${id}"/>
                <button id="Modify"type="button">修改確定</button>
                <button id="btnins"type="button">更多次選單</button>`;
              jQuery("#cvr").html(row);
              jQuery("#cover").fadeIn();
            }
          );
        }
      );
      jQuery("form").on(
        'click',
        "#Modify",
        () => {
          let id = jQuery("#main-id").val()
          let row = rows.find(r => r.Id === parseInt(id))
          console.info(row)
          jQuery("#cvr table tbody tr").each(
            function () {
              //批次刪除(子選單)
              if (jQuery(this).find(":checkbox[name='sub-delete']").prop('checked')) {
                if (jQuery(this).attr('id')) {
                jQuery.ajax({
                  url: `${API_PATH}/Remove.ashx`,
                  method: 'get',
                  async: false,
                  data: {
                    item: 'SubMenu',
                    Id: jQuery(this).attr('id').replace('sub-', '')
                  },
                  success(response1){
                    if (response1 === 'success') {
                      jQuery.ajax({
                        url: `${API_PATH}/Counter.ashx`,
                        async: false,
                        method: 'get',
                        data: {
                          item: 'MinusMenu',
                          Id: id,
                        },
                        success (response2) { if (response2 === 'success') jQuery("#cover").fadeOut(); }
                      })
                    }
                  }
                })
                } else {
                  jQuery(this).remove();
                }
              }
              if (jQuery(this).attr('id')) {
                //批次修改(子選單)
                jQuery.post(
                  `${API_PATH}/Modify.ashx`,
                  {
                    item: 'SubMenu',
                    Id: jQuery(this).attr('id').replace('sub-', ''),
                    Father: id,
                    Name: jQuery(this).find(":text[name='sub-name']").val(),
                    Url: jQuery(this).find(":text[name='sub-url']").val()
                  },
                  response => { if (response !== 'fail') jQuery("#cover").fadeOut(); }
                );
              } else {
                //新增子選單
                jQuery.ajax({
                  url: `${API_PATH}/Add.ashx`,
                  method: 'post',
                  data: {
                    item: 'SubMenu',
                    Father: id,
                    Name: jQuery(this).find(":text[name='sub-name']").val(),
                    Url: jQuery(this).find(":text[name='sub-url']").val()
                  },
                  async: false,
                  success (response1) {
                    if (response1 !== 'fail') { 
                    jQuery.ajax({
                      url: `${API_PATH}/Counter.ashx`,
                      method: 'get',
                      data: {
                        item: 'PlusMenu',
                        Id: id,
                      },
                      async: false,
                      success (response2) { if (response2 !== 'fail') jQuery("#cover").fadeOut(); }
                    })
                    }
                    }
                })
              }
              fetchrow() 
            }
          );
        }
      );
      jQuery("form").on(
        'click',
        "#btnins",
        () => {
          //在modal的表格內新增一列
          jQuery("#cvr table tbody").prepend(
            `<tr class="trce">
              <td>
                <input name="sub-name" type="text" />
              </td >
              <td>
                <input name="sub-url" type="text" />
              </td>
              <td>
                <input name="sub-delete" type="checkbox" />
              </td>
            </tr>`
          );
        }
      );
      jQuery("form").submit(
        event => {
          event.preventDefault();
          jQuery(".trce").each(
            function () {
              if (jQuery(this).find(":checkbox[name='main-delete']").prop('checked')) {
                //批次刪除(主選單)
                jQuery.get(
                  `${API_PATH}/Remove.ashx`,
                  {
                    item: 'MainMenu',
                    Id: jQuery(this).attr('id'),
                  }
                );
              } else {
                //批次修改(主選單)
                jQuery.post(
                  `${API_PATH}/Modify.ashx`,
                  {
                    item: 'MainMenu',
                    Id: jQuery(this).attr('id').replace('main-', ''),
                    Name: jQuery(this).find(":text[name='main-name']").val(),
                    Url: jQuery(this).find(":text[name='main-url']").val(),
                    Count: jQuery(this).find("td:nth-child(3)").text(),
                    Display: jQuery(this).find(":checkbox[name='main-display']").prop('checked') ? 'yes' : 'no'
                  }
                );
              }
            }
          );
          fetchrow()
}
      );
      function fetchrow () {
        //載入並渲染主選單
        jQuery.getJSON(
          `${API_PATH}/Fetch.ashx`,
          {
            item: 'MainMenu'
          },
          returns => {
            rows = returns;
            jQuery("tbody:nth-child(2)").html("");
            rows.forEach(
              value => {
                let row =
                  `<tr id="main-${value.Id}" class="trce">
                  <td>
                    <input name="main-name" type="text" value="${value.Name}"/>
                  </td>
                  <td>
                    <input name="main-url" type="text" value="${value.Url}"/>
                  </td>
                  <td>${value.Count}</td>
                  <td>
                    <input name="main-display" type="checkbox"`;
                if (value.Display === 'yes') { row += ' checked'; }
                row += `/>
                  </td>
                  <td>
                    <input name="main-delete" type="checkbox" />
                  </td>
                  <td>
                    <input name="Edit" type="button" value="編輯次選單" />
                  </td>
                '</tr>`;
                jQuery("tbody:nth-child(2)").append(row);
              }
            );
          }
        );
      }
    }
  );
</script>
