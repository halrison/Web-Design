<p class="t cent botli">動態文字廣告管理</p>
<table style="width:100%">
  <thead>
    <tr class="yel">
      <th style="width:68%">動態文字廣告</th>
      <th style="width:7%">顯示</th>
      <th style="width:7%">刪除</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<table style="margin-top:10px; width:70%;">
  <tbody>
    <tr>
      <td style="width:200px">
        <input type="button" id="btnadd" />
      </td>
      <td class="cent">
        <input type="submit" value="修改確定" />
        <input type="reset" value="重置" />
      </td>
    </tr>
  </tbody>
</table>
<script>
  jQuery(document).ready(function () {
    //根據域名決定請求路徑
    const API_PATH = location.hostname === 'localhost' ? '/ClassB/WebB01' : '..';
    let rows = [];
    //載入並渲染動態文字廣告
    fetchrow();
    //渲染並顯示modal
    jQuery("#btnadd").val('新增動態文字廣告').click(() => {
      jQuery("#cvr").html(
        `<p class="t cent">新增動態文字廣告</p>
        <hr/>
        動態文字廣告：<input id="AdText" type="text" style="width:650px"/><br/>
        <button id="Insert" type="button">新增</button>
        <button id="Clear" type="button">重置</button>`
      );
      jQuery("#cover").fadeIn();
    });
    //新增動態文字廣告，並新增一列表格以顯示
    jQuery("form").on('click', "#Insert", () => {
      jQuery.post(
        `${API_PATH}/Add.ashx`,
        {
          item: 'DynamicText',
          Message: jQuery("#AdText").val(),
          Display: 'no'
        },
        returns => {
          if (returns !== 'fail') jQuery("#cover").fadeOut();
        }
      );
      fetchrow();
    });
    jQuery("form").on('click', "#Clear", () => {
      //清除動態文字廣告
      jQuery("#AdText").empty();
    })
    jQuery("form").submit(event => {
      event.preventDefault();
      jQuery.each(
        jQuery("tbody:nth-child(2) tr"),
        function () {
          if (jQuery(this).find("input[name='delete']").prop('checked')) {
            //批次刪除
            jQuery.get(
              `${API_PATH}/Remove.ashx`,
              {
                item: 'DynamicText',
                Id: jQuery(this).attr('id')
              },
              result => {
                if (result === 'success') { jQuery(this).remove(); }
              }
            );
          } else {
            //批次修改
            jQuery.post(
              `${API_PATH}/Modify.ashx`,
              {
                item: 'DynamicText',
                Id: jQuery(this).attr('id'),
                Message: jQuery(this).find("input:text").val(),
                Display: jQuery(this).find("input[name='display']").prop('checked') ? 'yes' : 'no'
              }
            );
          }
        }
      );
      fetchrow();
});
    function fetchrow () {
      jQuery.getJSON(
        `${API_PATH}/Fetch.ashx`,
        {
          item: 'DynamicText'
        },
        returns => {
          rows = returns, 
            jQuery("tbody:nth-child(2)").html("");
rows.forEach(
            value => {
              let row = `<tr id='${value.Id}' class='trce'>
                          <td><input type='text' value='${value.Message}' style="width:90%"/></td>
                          <td><input type='checkbox' name='display'`;
              if (value.Display === 'yes') { row += ` checked`; }
              row += `/></td>
                          <td><input type='checkbox' name='delete'/></td>
                          </tr>`;
              jQuery("tbody:nth-child(2)").append(row);
            }
          )
        }
      );
    }
  });
</script>
